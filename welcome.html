<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlakeMonster — Welcome</title>
  <link rel="icon" type="image/svg+xml" href="website/logo.svg">
  <link rel="stylesheet" href="website/styles.css">

  <script>
    (function() {
      var t = localStorage.getItem('theme');
      if (!t) t = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-theme-toggle]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
          });
        });
      });
    })();
  </script>
</head>
<body>

  <!-- Top Nav -->
  <nav class="top-nav">
    <div class="top-nav-inner">
      <a href="index.html" class="nav-brand">FlakeMonster</a>
      <div class="nav-links">
        <a href="index.html#ci-section">CI</a>
        <a href="index.html#pricing-section">Pricing</a>
        <a href="docs/">Docs</a>
        <a href="https://github.com/growthboot/FlakeMonster">GitHub</a>
        <a href="account.html" class="nav-account-link">Account</a>
        <button class="theme-toggle" data-theme-toggle aria-label="Toggle dark mode"></button>
      </div>
    </div>
  </nav>

  <!-- Welcome Banner -->
  <div class="pricing-banner pricing-banner-success" id="welcome-banner" style="display:none"></div>

  <!-- State: Not signed in -->
  <div id="state-signed-out">
    <section class="setup-page-header">
      <h1>Welcome to FlakeMonster Pro</h1>
      <p>Sign in with Google to activate your Pro subscription.</p>
    </section>
    <div class="welcome-content">
      <div class="welcome-card">
        <h3>Activate Your Subscription</h3>
        <p>Signing in links your Google account to this repository's Pro plan. This lets you manage billing, view analytics, and access your account.</p>
        <button class="welcome-google-btn" id="google-signin-btn">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
          Sign in with Google
        </button>
        <div class="welcome-msg welcome-msg-error" id="auth-error"></div>
      </div>
    </div>
  </div>

  <!-- State: Signed in -->
  <div id="state-signed-in" style="display:none">
    <section class="setup-page-header">
      <h1>You're All Set</h1>
      <p>Thanks for subscribing, <strong id="auth-email"></strong>. Your account is linked and ready to go.</p>
    </section>
    <div class="welcome-content">

      <!-- Community & Support -->
      <div class="welcome-card">
        <h3>Community & Support</h3>
        <p>Questions, feedback, or just want to say hi? We'd love to hear from you.</p>
        <div class="welcome-links">
          <a class="welcome-link-row" href="https://www.reddit.com/r/FlakeMonster/" target="_blank" rel="noopener">
            <div class="welcome-link-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm5.8 11.33c.02.16.03.33.03.5 0 2.55-2.97 4.63-6.63 4.63s-6.63-2.07-6.63-4.63c0-.17.01-.34.03-.5A1.45 1.45 0 012 10c0-.8.65-1.45 1.45-1.45.39 0 .74.16 1 .41 1.24-.89 2.95-1.47 4.85-1.53l.9-4.07a.3.3 0 01.36-.23l2.87.64a1.07 1.07 0 012.02.45c0 .59-.48 1.07-1.07 1.07s-1.07-.48-1.07-1.07l-.01-.12-2.52-.56-.79 3.6c1.85.07 3.52.65 4.74 1.52.26-.25.61-.41 1-.41.8 0 1.45.65 1.45 1.45 0 .53-.29 1-.72 1.26zM7.27 10c-.59 0-1.07.48-1.07 1.07s.48 1.07 1.07 1.07 1.07-.48 1.07-1.07S7.86 10 7.27 10zm5.46 0c-.59 0-1.07.48-1.07 1.07s.48 1.07 1.07 1.07 1.07-.48 1.07-1.07S13.32 10 12.73 10zm-5.18 3.27c-.12-.12-.12-.31 0-.43s.31-.12.43 0c.67.67 1.97.72 2.03.72s1.36-.05 2.03-.72a.3.3 0 01.43 0c.12.12.12.31 0 .43-.78.78-2.3.85-2.46.85s-1.68-.07-2.46-.85z"/></svg>
            </div>
            <div class="welcome-link-text">
              <strong>Reddit</strong>
              <span>r/FlakeMonster — community discussions</span>
            </div>
          </a>
          <a class="welcome-link-row" href="https://github.com/growthboot/FlakeMonster" target="_blank" rel="noopener">
            <div class="welcome-link-icon">
              <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
            </div>
            <div class="welcome-link-text">
              <strong>GitHub</strong>
              <span>Issues, source code, and releases</span>
            </div>
          </a>
          <a class="welcome-link-row" href="mailto:flakemonster@proton.me">
            <div class="welcome-link-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="16" height="12" rx="2"/><path d="M2 6l8 5 8-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="welcome-link-text">
              <strong>Email</strong>
              <span>flakemonster@proton.me — we reply fast</span>
            </div>
          </a>
        </div>
      </div>

      <!-- Continue to Setup -->
      <div class="welcome-card" style="text-align:center">
        <a href="setup.html" class="welcome-billing-btn" style="display:inline-flex;text-decoration:none">Continue to Setup Guide</a>
        <p style="margin-top:12px;margin-bottom:0">
          <a href="account.html" style="color:var(--accent);font-size:14px">or go to your Account</a>
        </p>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-inner" style="padding-top:32px">
      <div class="footer-bottom">
        <span>CLI licensed under MIT</span>
        <span class="footer-sep">&middot;</span>
        <a href="index.html" style="color:var(--accent);text-decoration:none">Back to FlakeMonster</a>
      </div>
    </div>
  </footer>

  <!-- Firebase Auth SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js';
    import { getAuth, signInWithPopup, onAuthStateChanged, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js';
    import { firebaseConfig } from './website/firebase-config.js';

    const app = initializeApp(firebaseConfig);

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const CLOUD_API = location.hostname === 'localhost' ? '' : 'https://api.flakemonster.com';

    // Parse URL params (from Stripe checkout redirect)
    const params = new URLSearchParams(location.search);
    const owner = params.get('owner');
    const repo = params.get('repo');
    const repoFullName = owner && repo ? `${owner}/${repo}` : null;

    // Show banner if coming from checkout
    if (repoFullName) {
      const banner = document.getElementById('welcome-banner');
      banner.textContent = `Your subscription is active! ${repoFullName} now has unlimited checks.`;
      banner.style.display = '';
    }

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      const signedOut = document.getElementById('state-signed-out');
      const signedIn = document.getElementById('state-signed-in');

      if (user) {
        signedOut.style.display = 'none';
        signedIn.style.display = '';
        document.getElementById('auth-email').textContent = user.email;

        // Link account if we have owner/repo from checkout URL
        if (owner && repo) {
          try {
            const token = await user.getIdToken();
            await fetch(`${CLOUD_API}/api/link-account`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
              },
              body: JSON.stringify({ owner, repo }),
            });
          } catch {
            // Linking failed silently — non-critical
          }
        }
      } else {
        signedOut.style.display = '';
        signedIn.style.display = 'none';
      }
    });

    // Google Sign-In
    document.getElementById('google-signin-btn').addEventListener('click', async () => {
      const errEl = document.getElementById('auth-error');
      errEl.style.display = 'none';
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        if (err.code !== 'auth/popup-closed-by-user') {
          errEl.textContent = err.message;
          errEl.style.display = 'block';
        }
      }
    });
  </script>

</body>
</html>
