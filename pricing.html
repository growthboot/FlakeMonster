<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlakeMonster CI — Upgrade to Pro</title>
  <link rel="icon" type="image/svg+xml" href="website/logo.svg">
  <link rel="stylesheet" href="website/styles.css">

  <script>
    (function() {
      var t = localStorage.getItem('theme');
      if (!t) t = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-theme-toggle]').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
          });
        });
      });
    })();
  </script>
</head>
<body>

  <!-- Top Nav -->
  <nav class="top-nav">
    <div class="top-nav-inner">
      <a href="index.html" class="nav-brand">FlakeMonster</a>
      <div class="nav-links">
        <a href="index.html#ci-section">CI</a>
        <a href="index.html#pricing-section">Pricing</a>
        <a href="docs/">Docs</a>
        <a href="https://github.com/growthboot/FlakeMonster">GitHub</a>
        <a href="account.html" class="nav-account-link">Account</a>
        <button class="theme-toggle" data-theme-toggle aria-label="Toggle dark mode"></button>
      </div>
    </div>
  </nav>

  <!-- Checkout -->
  <section class="checkout-section">
    <div class="checkout-card">
      <div class="checkout-header">
        <h1>Upgrade to Pro</h1>
        <div class="checkout-price">$29<span>/mo</span></div>
        <p>Unlimited GitHub Action checks. Cancel anytime.</p>
      </div>

      <form id="checkout-form">
        <!-- Primary: GitHub URL -->
        <div class="checkout-input-group" id="url-input-group">
          <div class="setup-form-field">
            <label for="checkout-url">GitHub repository URL</label>
            <input type="url" id="checkout-url" placeholder="https://github.com/your-org/your-repo">
          </div>
        </div>

        <!-- Secondary: Manual (hidden by default) -->
        <div class="checkout-input-group" id="manual-input-group" style="display:none">
          <div class="setup-form-field" style="margin-bottom:12px">
            <label for="checkout-owner">GitHub owner</label>
            <input type="text" id="checkout-owner" placeholder="user-or-org">
          </div>
          <div class="setup-form-field">
            <label for="checkout-repo">Repository</label>
            <input type="text" id="checkout-repo" placeholder="repo-name">
          </div>
        </div>

        <button type="button" class="checkout-toggle" id="input-toggle">Enter manually instead</button>

        <button type="submit" class="pricing-btn pricing-btn-primary checkout-submit" id="checkout-btn">Continue to Checkout</button>
        <div class="pricing-form-error" id="checkout-error"></div>
      </form>

      <div class="checkout-footer">
        <span>Secure checkout via Stripe</span>
        <span class="footer-sep">&middot;</span>
        <span>Looking for the free tier? <a href="setup.html">Set up here</a></span>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-inner" style="padding-top:32px">
      <div class="footer-bottom">
        <span>CLI licensed under MIT</span>
        <span class="footer-sep">&middot;</span>
        <a href="index.html" style="color:var(--accent);text-decoration:none">Back to FlakeMonster</a>
      </div>
    </div>
  </footer>

  <script>
    const CLOUD_API = location.hostname === 'localhost' ? '' : 'https://api.flakemonster.com';

    // ── Input mode toggle ──
    const urlGroup = document.getElementById('url-input-group');
    const manualGroup = document.getElementById('manual-input-group');
    const toggle = document.getElementById('input-toggle');
    let mode = 'url';

    toggle.addEventListener('click', () => {
      if (mode === 'url') {
        mode = 'manual';
        urlGroup.style.display = 'none';
        manualGroup.style.display = 'block';
        toggle.textContent = 'Paste GitHub URL instead';
      } else {
        mode = 'url';
        urlGroup.style.display = 'block';
        manualGroup.style.display = 'none';
        toggle.textContent = 'Enter manually instead';
      }
    });

    // ── GitHub URL parsing ──
    function parseGitHubUrl(url) {
      try {
        const u = new URL(url);
        if (u.hostname !== 'github.com') return null;
        const parts = u.pathname.replace(/^\//, '').replace(/\.git$/, '').split('/');
        if (parts.length < 2 || !parts[0] || !parts[1]) return null;
        return { owner: parts[0], repo: parts[1] };
      } catch {
        return null;
      }
    }

    // ── Checkout form ──
    const form = document.getElementById('checkout-form');
    const btn = document.getElementById('checkout-btn');
    const error = document.getElementById('checkout-error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      error.style.display = 'none';

      let owner, repo;

      if (mode === 'url') {
        const val = document.getElementById('checkout-url').value.trim();
        const parsed = parseGitHubUrl(val);
        if (!parsed) {
          error.textContent = 'Please enter a valid GitHub repository URL (e.g. https://github.com/owner/repo)';
          error.style.display = 'block';
          return;
        }
        owner = parsed.owner;
        repo = parsed.repo;
      } else {
        owner = document.getElementById('checkout-owner').value.trim();
        repo = document.getElementById('checkout-repo').value.trim();
        if (!owner || !repo) {
          error.textContent = 'Please enter both the owner and repository name.';
          error.style.display = 'block';
          return;
        }
      }

      btn.disabled = true;
      btn.textContent = 'Redirecting to Stripe...';

      try {
        const res = await fetch(`${CLOUD_API}/api/checkout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ owner, repo }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Checkout failed');

        window.location.href = data.url;
      } catch (err) {
        error.textContent = err.message;
        error.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Continue to Checkout';
      }
    });

    // ── Post-Stripe redirect banners ──
    const params = new URLSearchParams(window.location.search);
    if (params.get('upgraded') === '1') {
      const b = document.createElement('div');
      b.className = 'pricing-banner pricing-banner-success';
      b.textContent = 'Upgrade successful! Your repository now has unlimited checks.';
      document.body.prepend(b);
    }
    if (params.get('cancelled') === '1') {
      const b = document.createElement('div');
      b.className = 'pricing-banner pricing-banner-error';
      b.textContent = 'Checkout cancelled. You can try again anytime.';
      document.body.prepend(b);
    }
  </script>

</body>
</html>
